#!/usr/bin/env node

/**
 * Parse claude.md setup guide and extract structured setup instructions
 * Usage: node parse-claude-md.js <path-to-claude.md>
 */

const fs = require('fs');
const path = require('path');

function parseClaudeMd(filePath) {
  if (!fs.existsSync(filePath)) {
    console.error(JSON.stringify({ error: 'claude.md not found' }));
    process.exit(1);
  }

  const content = fs.readFileSync(filePath, 'utf-8');

  // Check if it's a setup guide
  if (!content.includes('Auto-generated by /init:')) {
    console.error(JSON.stringify({
      error: 'Not a setup guide. claude.md appears to be project documentation.'
    }));
    process.exit(1);
  }

  const instructions = {
    metadata: extractMetadata(content),
    dependencies: extractDependencies(content),
    folders: extractFolderStructure(content),
    fonts: extractFontTasks(content),
    configs: extractConfigTasks(content),
  };

  // Output as JSON
  console.log(JSON.stringify(instructions, null, 2));
}

/**
 * Extract project metadata
 */
function extractMetadata(content) {
  const metadata = {
    project_name: extractValue(content, /\*\*Project Name\*\*:\s*(.+)/),
    framework: detectFramework(content),
    typescript: content.includes('**TypeScript**: âœ…') || content.includes('TypeScript: Yes'),
    router: extractValue(content, /\*\*Router\*\*:\s*(.+)/),
    ui_library: extractValue(content, /\*\*UI Library\*\*:\s*(.+)/),
    font_dir: extractFontDir(content),
  };

  return metadata;
}

/**
 * Detect framework from content
 */
function detectFramework(content) {
  if (content.includes('Expo') || content.includes('expo')) {
    return 'expo';
  } else if (content.includes('Next.js') || content.includes('nextjs')) {
    return 'nextjs';
  }
  return 'unknown';
}

/**
 * Extract font directory
 */
function extractFontDir(content) {
  const framework = detectFramework(content);

  // Try to find explicitly mentioned font dir
  const match = content.match(/\*\*Target\*\*:\s*`(.+?)`/);
  if (match) {
    return match[1];
  }

  // Default based on framework
  return framework === 'expo' ? 'assets/fonts' : 'public/fonts';
}

/**
 * Extract dependencies from setup guide
 */
function extractDependencies(content) {
  const deps = [];

  // Find code blocks with bash/sh
  const codeBlockRegex = /```(?:bash|sh)\n([\s\S]*?)```/g;
  let match;

  while ((match = codeBlockRegex.exec(content)) !== null) {
    const block = match[1];

    // Extract commands (npm, npx, yarn, pnpm)
    const lines = block.split('\n');
    for (const line of lines) {
      const trimmed = line.trim();

      // Skip comments and empty lines
      if (trimmed.startsWith('#') || trimmed === '') {
        continue;
      }

      // Detect package manager commands
      if (
        trimmed.startsWith('npm ') ||
        trimmed.startsWith('npx ') ||
        trimmed.startsWith('yarn ') ||
        trimmed.startsWith('pnpm ')
      ) {
        deps.push(trimmed);
      }
    }
  }

  return deps;
}

/**
 * Extract folder structure
 */
function extractFolderStructure(content) {
  const folders = [
    'components/atoms',
    'components/molecules',
    'components/organisms',
    'components/templates',
    'hooks',
    'utils',
    'types',
    'schema',
    'libs',
    'stores',
    'styles',
    'constants',
    'mock',
  ];

  // Add framework-specific folders
  const framework = detectFramework(content);
  if (framework === 'expo') {
    folders.push('assets/fonts', 'assets/images');
  } else if (framework === 'nextjs') {
    folders.push('public/fonts');
  }

  return folders;
}

/**
 * Extract font download tasks
 */
function extractFontTasks(content) {
  const fonts = [
    {
      name: 'Pretendard-Regular.woff2',
      url: 'https://cdn.jsdelivr.net/gh/fonts-archive/Pretendard/Pretendard-Regular.woff2',
    },
    {
      name: 'Pretendard-Medium.woff2',
      url: 'https://cdn.jsdelivr.net/gh/fonts-archive/Pretendard/Pretendard-Medium.woff2',
    },
    {
      name: 'Pretendard-SemiBold.woff2',
      url: 'https://cdn.jsdelivr.net/gh/fonts-archive/Pretendard/Pretendard-SemiBold.woff2',
    },
    {
      name: 'Pretendard-Bold.woff2',
      url: 'https://cdn.jsdelivr.net/gh/fonts-archive/Pretendard/Pretendard-Bold.woff2',
    },
  ];

  return fonts;
}

/**
 * Extract configuration file tasks
 */
function extractConfigTasks(content) {
  const framework = detectFramework(content);
  const configs = [];

  if (framework === 'expo') {
    configs.push(
      'tailwind.config.js',
      'babel.config.js',
      'metro.config.js',
      'styles/global.css',
      'constants/theme.ts'
    );
  } else if (framework === 'nextjs') {
    configs.push(
      'tailwind.config.ts',
      'postcss.config.mjs',
      'styles/globals.css',
      'constants/theme.ts'
    );
  }

  return configs;
}

/**
 * Extract value from regex match
 */
function extractValue(content, regex) {
  const match = content.match(regex);
  return match ? match[1].trim() : '';
}

// Main execution
const args = process.argv.slice(2);
if (args.length === 0) {
  console.error('Usage: node parse-claude-md.js <path-to-claude.md>');
  process.exit(1);
}

const filePath = args[0];
parseClaudeMd(filePath);
