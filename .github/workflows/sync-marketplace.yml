name: Sync Marketplace

on:
  schedule:
    # Run every Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'skills/**'
      - 'agents/**'
      - 'commands/**'
      - '.claude-plugin/**'

jobs:
  sync:
    name: Synchronize Marketplace Catalog
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Generate marketplace catalog
        run: |
          chmod +x scripts/generate-catalog.sh
          ./scripts/generate-catalog.sh

      - name: Update plugin.json with latest skills
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');

          // Read current plugin.json
          const pluginPath = '.claude-plugin/plugin.json';
          const plugin = JSON.parse(fs.readFileSync(pluginPath, 'utf8'));

          // Scan all skills
          const skillsDir = 'skills';
          const categories = fs.readdirSync(skillsDir);
          const skills = [];

          categories.forEach(category => {
            const categoryPath = path.join(skillsDir, category);
            if (fs.statSync(categoryPath).isDirectory()) {
              const skillDirs = fs.readdirSync(categoryPath);

              skillDirs.forEach(skillDir => {
                const skillPath = path.join(categoryPath, skillDir, 'SKILL.md');
                if (fs.existsSync(skillPath)) {
                  const content = fs.readFileSync(skillPath, 'utf8');

                  // Extract frontmatter
                  const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
                  if (frontmatterMatch) {
                    const frontmatter = {};
                    frontmatterMatch[1].split('\n').forEach(line => {
                      const [key, ...valueParts] = line.split(':');
                      if (key && valueParts.length > 0) {
                        frontmatter[key.trim()] = valueParts.join(':').trim();
                      }
                    });

                    skills.push({
                      id: frontmatter.name || skillDir,
                      name: frontmatter.name || skillDir,
                      category: category,
                      path: path.join(skillsDir, category, skillDir),
                      version: frontmatter.version || '0.0.0',
                      status: frontmatter.status || 'beta'
                    });
                  }
                }
              });
            }
          });

          // Update plugin.json
          plugin.skills = skills;
          plugin.catalog = {
            ...plugin.catalog,
            lastUpdated: new Date().toISOString(),
            totalSkills: skills.length
          };

          fs.writeFileSync(pluginPath, JSON.stringify(plugin, null, 2));
          console.log('✅ Updated plugin.json with', skills.length, 'skills');
          "

      - name: Update marketplace.json
        run: |
          node -e "
          const fs = require('fs');

          const marketplacePath = '.claude-plugin/marketplace.json';
          const marketplace = JSON.parse(fs.readFileSync(marketplacePath, 'utf8'));

          // Update catalog metadata
          marketplace.catalog.lastUpdated = new Date().toISOString();

          fs.writeFileSync(marketplacePath, JSON.stringify(marketplace, null, 2));
          console.log('✅ Updated marketplace.json');
          "

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add .claude-plugin/*.json
            git commit -m "chore: Auto-sync marketplace catalog [skip ci]"
            git push
            echo "✅ Committed and pushed catalog updates"
          fi

      - name: Create sync report
        run: |
          echo "# Marketplace Sync Report" > sync-report.md
          echo "" >> sync-report.md
          echo "**Date**: $(date)" >> sync-report.md
          echo "**Trigger**: ${{ github.event_name }}" >> sync-report.md
          echo "" >> sync-report.md
          echo "## Statistics" >> sync-report.md
          echo "- Total skills: $(find skills -name 'SKILL.md' | wc -l)" >> sync-report.md
          echo "- Total agents: $(find agents -name 'AGENT.md' | wc -l)" >> sync-report.md
          echo "- Total commands: $(find commands -name '*.md' | wc -l)" >> sync-report.md
          echo "" >> sync-report.md
          echo "## Categories" >> sync-report.md
          for category in skills/*; do
            if [ -d "$category" ]; then
              count=$(find "$category" -name 'SKILL.md' | wc -l)
              echo "- $(basename $category): $count skills" >> sync-report.md
            fi
          done

      - name: Upload sync report
        uses: actions/upload-artifact@v4
        with:
          name: sync-report
          path: sync-report.md
