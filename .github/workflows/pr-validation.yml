name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-pr:
    name: Validate Pull Request
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"

          # Check if title follows conventional commits format
          if ! echo "$PR_TITLE" | grep -qE '^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .+'; then
            echo "❌ PR title must follow conventional commits format:"
            echo "   feat(scope): description"
            echo "   fix(scope): description"
            echo "   docs(scope): description"
            echo ""
            echo "Current title: $PR_TITLE"
            exit 1
          fi

          echo "✅ PR title format is valid"

      - name: Check for required labels
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            const requiredLabels = ['skill', 'agent', 'command', 'documentation', 'bugfix'];

            const hasRequiredLabel = requiredLabels.some(label => labels.includes(label));

            if (!hasRequiredLabel) {
              core.setFailed(`PR must have at least one of these labels: ${requiredLabels.join(', ')}`);
            } else {
              console.log('✅ PR has required labels:', labels);
            }

      - name: Check for CHANGELOG update
        run: |
          if git diff --name-only origin/main...HEAD | grep -q "CHANGELOG.md"; then
            echo "✅ CHANGELOG.md has been updated"
          else
            echo "⚠️ Warning: CHANGELOG.md not updated"
            echo "Please update CHANGELOG.md with your changes"
          fi
        continue-on-error: true

      - name: Check file changes
        run: |
          # Get changed files
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check if changes are in appropriate directories
          if echo "$CHANGED_FILES" | grep -qE '^skills/|^agents/|^commands/|^docs/|^\.claude-plugin/'; then
            echo "✅ Changes are in valid directories"
          else
            echo "⚠️ Warning: Changes outside standard directories detected"
          fi

      - name: Validate new skills
        run: |
          # Find new SKILL.md files
          NEW_SKILLS=$(git diff --name-only --diff-filter=A origin/main...HEAD | grep 'SKILL.md' || true)

          if [ -n "$NEW_SKILLS" ]; then
            echo "New skills detected:"
            echo "$NEW_SKILLS"

            for skill in $NEW_SKILLS; do
              echo ""
              echo "Validating $skill..."

              # Check required sections
              if ! grep -q "## 목적" "$skill"; then
                echo "❌ Missing '목적' section in $skill"
                exit 1
              fi

              if ! grep -q "## 사용 시기" "$skill"; then
                echo "❌ Missing '사용 시기' section in $skill"
                exit 1
              fi

              if ! grep -q "## 예제" "$skill"; then
                echo "❌ Missing '예제' section in $skill"
                exit 1
              fi

              echo "✅ $skill is valid"
            done
          else
            echo "No new skills in this PR"
          fi

      - name: Check for tests
        run: |
          # Check if tests directory exists for new skills
          NEW_SKILLS=$(git diff --name-only --diff-filter=A origin/main...HEAD | grep 'SKILL.md' || true)

          if [ -n "$NEW_SKILLS" ]; then
            for skill in $NEW_SKILLS; do
              skill_dir=$(dirname "$skill")
              test_dir="$skill_dir/tests"

              if [ ! -d "$test_dir" ]; then
                echo "⚠️ Warning: No tests directory for $skill"
                echo "Consider adding tests in $test_dir"
              fi
            done
          fi
        continue-on-error: true

      - name: Generate PR summary
        run: |
          echo "# PR Validation Summary" > pr-summary.md
          echo "" >> pr-summary.md
          echo "**PR**: #${{ github.event.pull_request.number }}" >> pr-summary.md
          echo "**Author**: @${{ github.event.pull_request.user.login }}" >> pr-summary.md
          echo "**Branch**: ${{ github.head_ref }}" >> pr-summary.md
          echo "" >> pr-summary.md

          echo "## Changed Files" >> pr-summary.md
          git diff --name-only origin/main...HEAD >> pr-summary.md
          echo "" >> pr-summary.md

          echo "## Statistics" >> pr-summary.md
          echo "- Files changed: $(git diff --name-only origin/main...HEAD | wc -l)" >> pr-summary.md
          echo "- Lines added: $(git diff --shortstat origin/main...HEAD | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+')" >> pr-summary.md
          echo "- Lines deleted: $(git diff --shortstat origin/main...HEAD | grep -oE '[0-9]+ deletion' | grep -oE '[0-9]+')" >> pr-summary.md

      - name: Upload PR summary
        uses: actions/upload-artifact@v4
        with:
          name: pr-summary
          path: pr-summary.md

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('pr-summary.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
